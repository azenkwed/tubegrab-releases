name: Cleanup old releases

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  cleanup:
    if: ${{ github.event.release.prerelease == false }}
    runs-on: ubuntu-latest
    steps:
      - name: Prune old releases
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const releases = await github.paginate(
              github.rest.repos.listReleases,
              { owner, repo, per_page: 100 }
            );

            const official = releases
              .filter((release) => !release.draft && !release.prerelease && release.published_at)
              .sort(
                (a, b) => new Date(b.published_at).getTime() - new Date(a.published_at).getTime()
              );

            const keepIds = new Set(official.slice(0, 3).map((release) => release.id));
            const deletable = releases.filter(
              (release) => !release.draft && !keepIds.has(release.id)
            );

            for (const release of deletable) {
              const label = release.name || release.tag_name || `id:${release.id}`;
              console.log(`Deleting release ${label}`);
              await github.rest.repos.deleteRelease({
                owner,
                repo,
                release_id: release.id
              });

              if (release.tag_name) {
                try {
                  await github.rest.git.deleteRef({
                    owner,
                    repo,
                    ref: `tags/${release.tag_name}`
                  });
                  console.log(`Deleted tag ${release.tag_name}`);
                } catch (error) {
                  const status = error.status || (error.response && error.response.status);
                  if (status === 404 || status === 422) {
                    console.log(`Tag ${release.tag_name} not found`);
                  } else {
                    throw error;
                  }
                }
              }
            }
